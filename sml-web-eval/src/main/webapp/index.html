<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html class="js" lang="en" dir="ltr" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head xmlns:update="http://ns.aksw.org/update/">

	<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <title>R2RML/SML Mapping Evaluation</title>


	<link rel="stylesheet" href="lib/twitter-bootstrap/2.0.3/css/bootstrap.min.css" />
	<link rel="stylesheet" type="text/css" href="lib/select2/3.3.2/select2.css" />
	<link rel="stylesheet" type="text/css" href="lib/jquery-ui/1.10.2/themes/base/jquery-ui.css" />

	<link rel="stylesheet" type="text/css" href="css/style-ontowiki.css" />
	<link rel="stylesheet" type="text/css" href="css/style.css" />

	
	<script type="text/javascript" src="lib/namespacedotjs/a28da387ce/Namespace.js"></script>
	<script type="text/javascript" src="lib/jquery/1.9.1/jquery-1.9.1.js"></script>
	<script type="text/javascript" src="lib/jQuery-ajaxTransport-XDomainRequest/current/jQuery.XDomainRequest.js"></script>
	<script type="text/javascript" src="lib/jquery-ui/1.10.2/ui/jquery-ui.js"></script>
	<script type="text/javascript" src="lib/underscore/1.4.4/underscore.js"></script>
	<script type="text/javascript" src="lib/underscore.string/current/dist/underscore.string.min.js"></script>
	<script type="text/javascript" src="lib/backbone/1.0.0/backbone.js"></script>
	<script type="text/javascript" src="lib/twitter-bootstrap/2.0.3/js/bootstrap.js"></script>
	<script type="text/javascript" src="lib/agility/current/agility.js" charset="utf-8"></script>
	<script type="text/javascript" src="lib/CryptoJS/3.0.2/components/core-min.js"></script>
	<script type="text/javascript" src="lib/CryptoJS/3.0.2/components/enc-utf16-min.js"></script>
	<script type="text/javascript" src="lib/CryptoJS/3.0.2/components/enc-base64-min.js"></script>
	<script type="text/javascript" src="lib/open-layers/2.12/OpenLayers.js"></script>
	<script type="text/javascript" src="lib/json-template/0.85/json-template.js"></script>
	<script type="text/javascript" src="lib/RDFauthor/current/libraries/jquery.rdfquery.rdfa-1.0.js"></script>
	<!-- <script type="text/javascript" src="lib/open-layers/2.10/extensions/OpenStreetMap/OpenStreetMap.js"></script> -->
	
	<script type="text/javascript" src="lib/select2/3.3.2/select2.js"></script>


	<script type="text/javascript">
		/**
		 * Adjusts the frontend according to the backend's state.
		 * Concretely loads the tasks and score sheet.
		 */
		var resetApp = function() {

			for(var i = 0; i < 4; ++i) {
				
				var taskNo = i + 1;
				
				createTab('#tabs', 'task' + taskNo, 'Task ' + taskNo, 'Foobar', 1 + i);
				
			}
		}
		
		
		var tableModel = {
			name: 'Person',
			head: [{
				name: 'id',
				type: 'int'
			}, {
				name: 'name',
				type: 'text'
			}],
			body: [
				{id: 1, name: 'Claus'},
				{id: 2, name: 'Joerg'}
			]
		};
	
	

		var renderTable = function(json) {
			var body = json.body;
			var head = json.head;
		
			var n = head.length;
			
			var titleN = Math.ceil(n / 2);
			
			var result = '<table class="separated-vertical">';
			
			result += '<tr>';
			result += '<td colspan="' + titleN + '">';
			result += json.name;
			result += '</td>';
			
			var m = body.length;
			
			
			// Write table heads
			result += '<tr>';
			for(var j = 0; j < n; ++j) {
				var colHead = head[j];
				var colName = colHead.name;
				
				result += '<th>';
				result += escapeHTML(colName);
				//result += '<br />';
				
				//result += escapeHTML(colName) + '<br />' + escapeHTML(colType);
				
				result += '</th>';
			}
			result += '</tr>';

			// Write table heads
			result += '<tr>';
			for(var j = 0; j < n; ++j) {
				var colHead = head[j];
				var colType = colHead.type;
				
				result += '<td>';
				result += '<span style="color: grey">(';
				result += escapeHTML(colType);
				result += ')</span>';
				result += '</td>';
			}
			result += '</tr>';
			
			// Write table body
			for(var i = 0; i < m; ++i) {
				var rowData = body[i];
				
				result += '<tr>';
				
				
				for(var j = 0; j < n; ++j) {
					var colHead = head[j];
					var colName = colHead.name
					
					var cellData = rowData[colName];
					
					result += '<td>';
					result += escapeHTML(cellData);
					result += '</td>';
				}
				result += '</tr>';
			}
			
			result += '<table>';
			
			return result;
		}
		
		
		
		
		
		// result format:
		/*
		    [{ subject: foobar, name, color: green, predicates: []]}]
		*/


		var ns = {};
		
		ns.Node = function(type, value, language, datatype) {
			this.type = type;
			this.value = value;
			this.language = language;
			this.datatype = datatype;
		};
		
		ns.Node.prototype = {
				getValue: function() {
					return this.value;
				},
		
				getType: function() {
					return this.type;
				},
		
				getLanguage: function() {
					return this.language;
				},
		
				getDatatype: function() {
					return this.datatype;
				},
				
				equals: function(that) {
					var result = _.isEqual(this, that);
					return result;
				},
				
				/**
				 * Warning: If fnNodeMap does not return a copy, the node will not be copied.
				 * In general, Node should be considered immutable!
				 * 
				 * @param fnNodeMap
				 * @returns
				 */
				copySubstitute: function(fnNodeMap) {
					var sub = fnNodeMap(this);		 
					var result = (sub == undefined || sub == null) ? this : sub;
					return result;
				},
				
				toString: function() {
					switch(this.type) {
					case -1: return "?" + this.value;
					case 0: return "_:" + this.value;
					case 1: return "<" + this.value + ">";
					case 2: return "\"" + this.value + "\"" + (this.language ? "@" + this.language : "");
					case 3: return "\"" + this.value + "\"" + (this.datatype ? "^^<" + this.datatype + ">" : "");
					}
				},
				
				isVar: function() {
					return this.type === -1;
				},
				
				isUri: function() {
					return this.type === ns.Node.Type.Uri;
				}
		};
		
		
		ns.Node.Type = {};
		ns.Node.Type.Variable = -1;
		ns.Node.Type.BlankNode = 0;
		ns.Node.Type.Uri = 1;
		ns.Node.Type.PlainLiteral = 2;
		ns.Node.Type.TypedLiteral = 3;
		
		ns.Node.fromJson = function(talisJson) {
			var result = new ns.Node();
			
			if(!talisJson || typeof(talisJson.type) === 'undefined') {
				console.log("Node: ", talisJson);
				throw "Invalid node";
			}
			
			var type;
			switch(talisJson.type) {
			case 'bnode': type = 0; break;
			case 'uri': type = 1; break;
			case 'literal': type = 2; break;
			case 'typed-literal': type = 3; break;
			default: console.error("Unknown type: '" + talisJson.type + "'");
			}
			
			result.type = type;
			result.value = talisJson.value;
			result.language = talisJson.lang ? talisJson.lang : "";
			result.datatype = talisJson.datatype ? talisJson.datatype : "";

			// TODO I thought it happened that a literal hat a datatype set, but maybe I was imaginating things
			if(result.datatype) {
				result.type = 3;
			}
			
			return result;
			/*
			var type = -2;
			if(node.type == "uri") {
				
			}*/
		};
		
		ns.Node.isNode = function(candidate) {
			return candidate && (candidate instanceof ns.Node);
		};
		
		ns.Node.isUri = function(candidate) {
			return ns.Node.isNode(candidate) && candidate.isUri();		
		};

		
		ns.Node.parse = function(str) {
			var str = str.trim();
			
			if(strings.startsWith(str, '<') && strings.endsWith(str, '>')) {		
				return ns.Node.uri(str.substring(1, str.length - 1));
			} else {
				throw "Node.parse not implemented for argument: " + str;
			}
		};
		
		ns.Node.uri = function(str) {
			return new ns.Node(1, str, null, null);
		};
			
		ns.Node.v = function(name) {
			return new ns.Node(-1, name, null, null);
		};
		
		ns.Node.blank = function(id) {
			return new ns.Node(0, id, null, null);
		};
		
		ns.Node.plainLit = function(value, language) {
			return new ns.Node(2, value, language, null);
		};
		
		ns.Node.typedLit = function(value, datatype) {
			return new ns.Node(3, value, null, datatype);
		};

		ns.Node.forValue = function(value) {
			var dt = typeof value;		
			if(dt === "number") {
				return ns.Node.typedLit(value, "http://www.w3.org/2001/XMLSchema#double");
			} else {
				console.error("No handling for datatype ", td);
			}
			
			//alert(dt);		
		};
		
		var getState = function(isExpected, isActual) {
			var result;
			
			if(isExpected) {
				if(isActual) {
					result = "covered";
				} else {
					result = "uncovered"
				}
			} else {
				if(isActual) {
					result = "excessive";
				} else {
					result = "invalid";
				}
			}
			
			return result;
		}
		
		var createDiff = function(expected, actual) {
			
			var result = diffResource(expected, actual, function(expected, actual) {
				var result = diffResource(expected, actual, function(expected, actual) {
					var result = diffObjects(_.values(expected), _.values(actual));
					return result;
				});
				return result;
			});
				
			return result;
		}
		
		var diffResource = function(expected, actual, fnProcessChildren) {
			var result = [];
			
			// Get all subjects
			var items =
				_.chain(_.keys(expected))
				.union(_.keys(actual))
				.uniq()
				.sort()
				.value();

			//console.log("[diffResource] items: ", items)
			
			for(var i = 0; i < items.length; ++i) {
				var item = items[i];
				
				//console.log('[diffResource] item:', item);
				
				var isExpected = item in expected;
				var isActual = item in actual;
				
				var state = getState(isExpected, isActual);
				
				var expectedChildren = item in expected ? expected[item] : {};
				var actualChildren = item in actual ? actual[item] : {};

				var children = fnProcessChildren(expectedChildren, actualChildren);
					
				result.push({
					item: item,
					state: state,
					children: children
				});
			}
			
			return result;
		}
		
		var diffObjects = function(expected, actual) {
			
			var myIndexOf = function(list, item) {
				var result = -1;
				
				for(var i = 0; i < list.length; ++i) {
					var it = list[i];
					
					if(_.isEqual(item, it)) {
						result = i;
						break;
					}
				}
				return result;
			}
			
			//console.log("[diffObjects] expected, actual: ", expected, actual);
			
			var rdfObjectToString = function(json) {
				var node = ns.Node.fromJson(json);
				var result = node.toString();
				return result;
			}
			
//			var items = _.chain().union(expected, actual).uniq(false, rdfObjectToString).sortBy(rdfObjectToString).value();

			var union = _.union(expected, actual);
			var uniq = _.uniq(union, false, rdfObjectToString);
			var items = _.sortBy(uniq, rdfObjectToString);
			console.log("items", items, expected, actual);

			
			var result = [];
			
			for(var i = 0; i < items.length; ++i) {
				var item = items[i];
				
				var isExpected = myIndexOf(expected, item) != -1;
				var isActual = myIndexOf(actual, item) != -1;
				console.log("On item: ", item, isExpected, isActual);
				
				var state = getState(isExpected, isActual);
				
				var resultItem = {
					item: item,
					state:state
				};
				
				result.push(resultItem);
			}
			
			return result;
		}
		
		
		var expected = {
				  "http://example.org/about" : 
				    {
				       "http://purl.org/dc/elements/1.1/title": [ { "type" : "literal" , "value" : "Anna's Homepage" }, { "type" : "literal" , "value" : "Peter's Homepage" } ]
				    },
				    
					  "http://example.org/goobar" : 
					    {
					       "http://purl.org/dc/elements/1.1/title": [ { "type" : "literal" , "value" : "Anna's Homepage" }, { "type" : "literal" , "value" : "Peter's Homepage" } ]
					    },
				};
			
		var actual = {
				  "http://example.org/about" : 
				    {
				       "http://purl.org/dc/elements/1.1/title": [ { "type" : "literal" , "value" : "Anna's Homepage" } ]
				    },
				  "http://example.org/foo" : 
				    {
				       "http://example.org/bar": [ { "type" : "literal" , "value" : "Baz" } ]
				    }
		};


		//console.log("The diff:", diff);
		
		// I think this is just the prototype escapeHTML method
		escapeHTML = function(text) {
			if(typeof(text) === 'number') {
				text = "" + text;
			}
			
			return !text ? "" : text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
		};

		
		var renderResource = function(item) {
			var str = item.item;
			var text = escapeHTML(str);
			var result = '<span class="' + item.state + '">' + text + '</span>';
			
			return result;
		}
		
		var renderObject = function(item) {
			var json = item.item;
			var node = ns.Node.fromJson(json);
			var str = node.toString();
			var text = escapeHTML(str);
			var result = '<span class="' + item.state + '">' + text + '</span>';
			
			return result;			
		}
		
		var renderDiff = function(subjects) {
			
			//var result = '<table>';
			var result = '<ul class="separated bullets-none">';
			
			for(var i = 0; i < subjects.length; ++i) {
				var subject = subjects[i];
								
				result += '</li>';
// 				result += '<tr>'
// 				result += '<td>';
				result += renderResource(subject); 
				//result += '</td><td>';
				
				var predicateStr = '<table class="separated-vertical" style="margin-left:15px; margin-bottom: 15px;">';
				
				// TODO color
				var predicates = subject.children;
				
				for(var j = 0; j < predicates.length; ++j) {
					var predicate = predicates[j];
					
					predicateStr += '<tr>';
					predicateStr += '<td style=" vertical-align: top;">' + renderResource(predicate) + '</td>';
					
					var objectStr = '<td><ul class="separated bullets-none">';
					
					var objects = predicate.children;
					for(var k = 0; k < objects.length; ++k) {
						var object = objects[k];
						
						var str = renderObject(object);
						
						objectStr += '<li>' + str + '</li>';
					}
					
					objectStr += '</ul></td>';
					
					predicateStr += objectStr;
					predicateStr + '</tr>';
				}
				
				predicateStr += '</table>';
				
				result += predicateStr;
				
				//result += '</td>';
				//result += '</tr>';
				result += '</li>';

			}
			
			//result += "</table>"
			result += '</ul>';
			return result;
		}
		
		var createTab = function(tab, idSuffix, head, body, index) {
			
			var $elTab = $(tab);
			
			var $elHeads = $elTab.find('> ul > li');
			var $elBodies = $elTab.find('> div > div');
			
			var idPrefix = $elTab.attr('id');
			
			var idHead = idPrefix + '-head-' + idSuffix; 
			var idBody = idPrefix + '-body-' + idSuffix;
			
			var $elLiHead = $('<li id="' + idHead + '" />');
			var $elDivBody = $('<div id="' + idBody + '" class="tab-pane" />');
			
			// Just in case there is a mismatch in the lengths...
			var n = Math.min($elHeads.length, $elBodies.length);
			
			var i = index;
			
			var isAppendMode = index >= n;
			if(isAppendMode) {
				i = n - 1;
			}
			//console.log("...", $elHeads, $elBodies, i);

			var $elHeadI = $elHeads.eq(i);
			var $elBodyI = $elBodies.eq(i);
			
			//console.log("---", $elHeadI, $elBodyI);
			
			if(isAppendMode) {
				$elHeadI.after($elLiHead);
				$elBodyI.after($elDivBody);
			} else {
				$elHeadI.before($elLiHead);
				$elBodyI.before($elDivBody);				
			}

			$elDivBody.append(body);

			var $elAHead = $('<a href="#' + idBody + '" />');
			$elLiHead.append($elAHead);
			$elAHead.append(head);
			
			$elAHead.click(function (e) {
		        e.preventDefault();
		        $(this).tab('show');
		    });
			
			//$('div.active').removeClass('active').removeClass('in');
			//$('li.active').removeClass('active');

// 			$(elTab, "> ")
// 			$('#myTabContent').append('<div class="tab-pane in active" id="new_tab_id"><p> Loading content ...</p></div>');
// 			$('#tab').append('<li><a href="#new_tab_id" data-toggle="tab">Tab Name</a></li>');
// 			$('#tab a:last').tab('show');
		}
	
		$(document).ready(function() {

			// Twitter Bootstrap's way of enabling tabs
			$('#tabs > ul > li > a').click(function (e) {
		        e.preventDefault();
		        $(this).tab('show');
		    });
	    	$('#tabs a:first').tab('show');

	    	resetApp();
	    	
	    	
	    	var tableHtml = renderTable(tableModel);
	    	$('.tableArea').html(tableHtml);
	    	
	    	
			var diff = createDiff(expected, actual);

			var html = renderDiff(diff);
			
			//console.log('HTML', html);
			var $elTarget = $('.rdfdiff');
			console.log('Target Element: ', $elTarget);
			$elTarget.html(html);
			

		});
	</script>
</head>

<body>
	<div class="container">

		<div id="header" class="row-fluid">
			<div class="span12 left-column">
				Some banner goes here
			</div>
		</div>

		<div id="tabs" style="height: 100%; width: 100%; padding-right: 0px;">

			<ul id="tabs-header" class="nav nav-tabs">
				<li id="tabs-head-signUp"><a href="#tab-body-signUp">Sign Up</a></li>
				<li id="tabs-head-scoreSheet"><a href="#tab-body-scoreSheet">Score Sheet</a></li>
			</ul>

			<div id="tabs-body" class="tab-content">

				<div id="tab-body-signUp" class="tab-pane">
					<ul>
					<li>In order to participate in the survey you need to log in.</li>
					<li>If you do not have an account yet, fill out <b>all</b> fields appropriately and click the 'Register & Log In' button in order to
					immediately log in into your new account.</li>
					<li>You can peek into what is awaiting you in the survey <b>without</b> logging in!</li>
					<li>We request your e-mail address <b>ONLY</b> for the purposes of password recovery and notifying you TODO</li>
					</ul>
				
					Username: <input type="text" />
					Password: <input type="text" />
					<br />
					<button id="logIn" class="btn btn-primary">Log In</button>

					Confirm Password: <input type="text" />
					Email: <input type="text" />
					Confirm Email: <input type="text" />
					<br />
					<button id="registerAndLogIn" class="btn btn-primary">Register & Log In</button>
					<form>
					
					</form>
				</div>

				<div id="tab-body-scoreSheet" class="tab-pane">
					<div class="row-fluid">
						<div class="span12">
							<h3>Task 1: Complete the given mapping so that the triples created from it match the reference data set.</h3>
							<p>
							The triples with the country and mbox properties are missing. 
							</p>
						</div>
					</div>
						
					<div class="row-fluid">
						<div class="tableArea span8" style="margin-bottom: 15px">
						</div>
					</div>
					<div class="row-fluid">
						<div class="span8">
							<textarea id="sql" class="span12" style="resize:none" rows="20">Create ...</textarea>
						</div>
						<div class="rdfdiff span4">
							Result goes here
						</div>
					</div>
					<div class="row-fluid">
						<div class="span8">
							<div style="float:right">
								<button class="btn btn-primary">Run!</button>
							</div>
						</div>
					</div>

				
				</div>					
			</div>
		</div>
	</div>

</body>
</html>
